services:
  website:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/matiasinsaurralde/website:static
    # Consider pinning to a digest (image@sha256:...) for supply-chain safety.
    container_name: website
    restart: always
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    pids_limit: 200
    labels:
      - diun.enable=true
    networks:
      - internal
    # Remove port exposure since Nginx will proxy to internal network

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: always
    read_only: true
    tmpfs:
      - /var/cache/nginx:rw,noexec,nosuid,size=64m
      - /var/run:rw,noexec,nosuid,size=16m
      - /etc/nginx/conf.d:rw,noexec,nosuid,size=1m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    pids_limit: 200
    ports:
      - "0.0.0.0:80:80"
    environment:
      - X_ORIGIN_VERIFY=${X_ORIGIN_VERIFY:?set X_ORIGIN_VERIFY in .env}
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/templates/default.conf.template:/etc/nginx/templates/default.conf.template:ro
      - ./logs:/var/log/nginx
    depends_on:
      - website
    networks:
      - internal

  diun:
    image: ghcr.io/crazy-max/diun:latest
    container_name: diun
    command: serve
    restart: always
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=32m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    pids_limit: 100
    environment:
      - TZ=UTC
      - DIUN_WATCH_SCHEDULE=0 */6 * * *
      - DIUN_WATCH_JITTER=30s
      - DIUN_PROVIDERS_DOCKER=true
      - DIUN_PROVIDERS_DOCKER_WATCHBYDEFAULT=false
      - DIUN_NOTIF_SCRIPT_CMD=/bin/sh
      - DIUN_NOTIF_SCRIPT_ARGS=/diun/restart.sh
      - DIUN_NOTIF_SCRIPT_DIR=/workspace
    volumes:
      - ./data/diun:/data
      - ./diun:/diun:ro
      - ./:/workspace:ro
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - diun.enable=true

networks:
  internal:
    driver: bridge
